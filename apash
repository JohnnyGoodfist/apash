#!/usr/bin/env sh

##############################################################################
# @name apash
# @brief Wrapper of the main script to execute apash with the desired interpreter.
#
# @description
#   Launch apash according to the environment.
#   Note: POSIX operations as much as possible in this script.
#
#   Logic:
#      1. Determine the shell type.
#      2. Exit if the shell is not supported.
#      3. Determine the HOME dir.
#      4. Force the interpreter of the main script.
#

##############################################################################
# Primary checks prefered in the main flow than embedded in a function
##############################################################################
# If already set in env, then skip calculation.
# Get the type of shell (only bash supported for the moment).
if [ -z "$APASH_SHELL" ];then
  if [ -n "$BASH_VERSION" ]; then    
    APASH_SHELL="bash"
  elif [ -n "$ZSH_VERSION" ]; then
    APASH_SHELL="zsh"
  fi
fi
export APASH_SHELL

# Prevent execution if not a supported shell.
if [ ! "$APASH_SHELL" = "bash" ] && [ ! "$APASH_SHELL" = "zsh" ];then
  echo "$(date -u +"%FT%T.%3N%z") [FATAL] apash ($LINENO): The shell '$APASH_SHELL' is not supported"
fi

# Calculate potential apash home directory if not defined.
if [ -z "$APASH_HOME_DIR" ]; then
  if [ "$APASH_SHELL" = "bash" ]; then
    APASH_HOME_DIR=$(dirname "$(realpath "$(command -v -- "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")")
  elif [ "$APASH_SHELL" = "zsh" ]; then
    APASH_HOME_DIR="${0:h}"
  # else # POSIX
    # APASH_HOME_DIR="$( cd -P -- "$(dirname -- "$(command -v -- "$0")")" && pwd -P )"
  fi
fi
export APASH_HOME_DIR

# Execute the main script according to its shell
if [ $# -eq 0 ] || [ "$1" = "source" ]; then
  # @todo POSIX way to pass all arguments to sourced script must be implemented.
  if [ "$2" = "--all" ] || [ "$2" = "-a" ]; then
    APASH_SOURCE_ALL="true" . "$APASH_HOME_DIR/apash.$APASH_SHELL"
  else
    . "$APASH_HOME_DIR/apash.$APASH_SHELL"
  fi
else
  "$APASH_HOME_DIR/apash.$APASH_SHELL" "$@"
fi
