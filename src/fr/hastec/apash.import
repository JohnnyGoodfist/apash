#!/usr/bin/env bash
# shellcheck disable=SC1090
apash.import(){
  local lib vlib version
  local libs=()
  local forceFlag=false
  local location=""
  local APASH_SRC_DIR="$APASH_HOME_DIR/src"
  [ "$1" = "-f" ] && forceFlag=true && shift

  for l in "$@"; do
    location="$APASH_SRC_DIR/"${l//./\/}

    # Shortcut resolution if the function <package>.<method> already exists.
    [ "$forceFlag" = "false" ] && typeset -f "$(basename "$(dirname "$l")").$(basename "${l%.*}")" > /dev/null 2>&1 && continue

    # Import package
    if [ -d "$location" ]; then
      for lib in "$location"/*.sh; do
        libs+=("$lib")
      done
    
    # Import a single class or method
    elif [ -r "${location}.sh" ]; then
      libs+=("$location.sh")

    # Import a file terminating by .sh
    elif [ -r "${location//\/sh/}.sh" ]; then
      libs+=("${location//\/sh/}.sh")
    
    # Check if raw value is a package
    elif [ -d "$l" ]; then
      location="$l"
      for lib in "$location"/*.sh; do
        libs+=("$lib")
      done

    # Check if relative raw value is a package
    elif [ -d "$APASH_SRC_DIR/$l" ]; then
      location="$APASH_SRC_DIR/$l"
      for lib in "$location"/*.sh; do
        libs+=("$lib")
      done
    
    # Check if relative raw value is a script
    elif [ -f "$APASH_SRC_DIR/$l" ]; then
      libs+=("$APASH_SRC_DIR/$l")

    # Import the raw file path
    elif [ -r "$l" ]; then
      libs+=("$l")
    
    # The library connot be imported
    else
      echo "$(date +"%FT%T.%3N%z") [WARNING] apash.import ($LINENO): Unknown library: '$l' - '$location'" >&2
      continue
    fi
  done

  for lib in "${libs[@]}"; do
    # Change lib in case a variant exist for the current shell.
    [[ -f "${lib%.*}.$APASH_SHELL" ]] && lib="${lib%.*}.$APASH_SHELL"

    if [[ -e "${lib%.*}.${APASH_SHELL}_*" ]]; then
      # Overide the library whith a compatible version of the same shell
      for vlib in "${lib%.*}.${APASH_SHELL}_"*; do
        [ ! -r "$vlib" ] && continue
        version="${vlib#*_}"
        # Sort -V not present in zsh (so use manual numeric sort)
        if [[ "$(echo -e "$APASH_SHELL_VERSION\n$version" |sort -t. -k 1.2,1n -k 2,2n -k 3,3n | head -n1)" == "$APASH_SHELL_VERSION" ]]; then
          lib="$vlib" && break
        fi
      done
    fi

    [ ! -r "$lib" ] && echo "WARNING: non readable library: $lib" >&2 && continue
    if [[ $forceFlag == true ]]; then source "$lib"; continue; fi
    if ! typeset -f "$(basename "$(dirname "$lib")").$(basename "${lib%.*}")" > /dev/null 2>&1; then
      source "$lib"
    fi
  done
}

if [[ "$APASH_SHELL" == "bash" ]]; then
  export -f apash.import
elif [[ "$APASH_SHELL" == "zsh"  ]] && [[ ! ":${FPATH}:" =~ :${0:A:h}:  ]]; then
  # Autoload the function for the current shell and subshell
  # But function is not export to subprocesses. Can only resource the file.
  FPATH+=":${0:A:h}"
  autoload -Uz apash.import
fi
